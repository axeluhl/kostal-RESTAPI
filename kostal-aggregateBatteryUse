#!/bin/bash
# Base tariff: 31ct/kWh  (Maingau)
START_OF_COST_INTERVAL[0]=0
COST_CENTS_PER_KWH[0]=31
# New tariff as of 2023-01-01 08:00:00: 71ct/kWh (Maingau)
START_OF_COST_INTERVAL[1]=1672560003
COST_CENTS_PER_KWH[1]=71
# New tariff as of 2023-03-01 08:00:00: 54ct/kWh (Maingau)
START_OF_COST_INTERVAL[2]=1677657603
COST_CENTS_PER_KWH[2]=54
# New tariff as of 2023-11-24 08:00:00: 36ct/kWh (Gruenwelt)
START_OF_COST_INTERVAL[3]=1700812803
COST_CENTS_PER_KWH[3]=36
COST_INDEX=0
$(dirname ${0})/kostal-dumpBatteryUse | tail -n +4 | while read TIMESTAMP TOTAL_ACTIVE_POWER_KW BATTERY_SOC_PERCENT BATTERY_CHARGE_POWER_KW; do
  if [ ${TIMESTAMP} -ge ${START_OF_COST_INTERVAL[$COST_INDEX]} ]; then
    COST_INDEX=$(( COST_INDEX + 1 ))
  fi
  echo ${TIMESTAMP} ${TOTAL_ACTIVE_POWER_KW} ${BATTERY_SOC_PERCENT} ${BATTERY_CHARGE_POWER_KW} ${COST_CENTS_PER_KWH[$COST_INDEX]}
done
